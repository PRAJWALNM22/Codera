<!DOCTYPE html>
<html>
<head>
    <title>Chat Sync Test Guide</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: white; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #333; border-radius: 8px; }
        .step { background: #2a2a2a; padding: 15px; margin: 10px 0; border-left: 4px solid #0066cc; border-radius: 4px; }
        .good { color: #4ade80; }
        .warn { color: #fbbf24; }
        .important { color: #ef4444; font-weight: bold; }
        .code { background: #333; padding: 10px; border-radius: 4px; font-family: monospace; margin: 10px 0; }
        .button { padding: 12px 20px; background: #0066cc; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        .button:hover { background: #0052a3; }
    </style>
</head>
<body>
    <div class="container">
        <h1>💬 Cross-Tab Chat Synchronization Test</h1>
        
        <div class="section">
            <h2>🎯 Test Objective</h2>
            <p>Verify that chat messages sent in one browser tab appear in another tab (simulating real multiplayer chat).</p>
        </div>
        
        <div class="section">
            <h2>📋 Step-by-Step Test Instructions</h2>
            
            <div class="step">
                <h3>Step 1: Open First Tab</h3>
                <p>Click the button below to open the first battle mode tab:</p>
                <button class="button" onclick="openFirstTab()">🚀 Open Tab 1 (Your Messages)</button>
                <p class="warn">⚠️ Navigate to Battle Mode and scroll down to the chat section</p>
            </div>
            
            <div class="step">
                <h3>Step 2: Open Second Tab</h3>
                <p>Click this button to open a second tab (simulating another player):</p>
                <button class="button" onclick="openSecondTab()">🚀 Open Tab 2 (Friend's Messages)</button>
                <p class="warn">⚠️ Also navigate to Battle Mode and scroll to chat in this tab</p>
            </div>
            
            <div class="step">
                <h3>Step 3: Test Message Sync</h3>
                <ul>
                    <li><strong>In Tab 1:</strong> Type "Hello from Tab 1" and press Enter</li>
                    <li><strong>In Tab 2:</strong> Type "Hello from Tab 2" and press Enter</li>
                    <li><strong>Check Both Tabs:</strong> You should see BOTH messages in BOTH tabs</li>
                </ul>
                <p class="good">✅ Expected: Messages appear in both tabs automatically</p>
            </div>
            
            <div class="step">
                <h3>Step 4: Verify Features</h3>
                <ul>
                    <li>Messages from different tabs have different colored sender names</li>
                    <li>Your own messages show in <span class="good">green</span></li>
                    <li>Other messages show in <span style="color: #60a5fa;">blue</span></li>
                    <li>Timestamps display correctly</li>
                    <li>Auto-scroll works in both tabs</li>
                </ul>
            </div>
        </div>
        
        <div class="section">
            <h2>🔍 Debug Information</h2>
            <p><strong class="important">Open Browser Console (F12) to see debug messages:</strong></p>
            <div class="code">
💬 [CHAT] Sending message: [message text]
💬 [CHAT] Broadcasted message to other tabs
💬 [CHAT] Received broadcast from other tab: [message data]
💬 [CHAT] Added message from other tab: [message object]
💬 [CHAT] Listening for messages from other tabs
            </div>
        </div>
        
        <div class="section">
            <h2>🛠️ How Cross-Tab Sync Works</h2>
            <ol>
                <li><strong>localStorage Events:</strong> Browser's storage event API for cross-tab communication</li>
                <li><strong>Message Broadcasting:</strong> Each sent message is broadcasted to other tabs</li>
                <li><strong>Duplicate Prevention:</strong> Unique message IDs prevent duplicate messages</li>
                <li><strong>Room Isolation:</strong> Messages are scoped to specific battle rooms</li>
                <li><strong>Sender Filtering:</strong> Own messages aren't duplicated from broadcasts</li>
            </ol>
        </div>
        
        <div class="section">
            <h2>❌ Troubleshooting</h2>
            <div class="step">
                <h3>If messages don't sync:</h3>
                <ul>
                    <li>Check that both tabs are in the same battle room</li>
                    <li>Look for console errors (red text in browser console)</li>
                    <li>Ensure localStorage is enabled in your browser</li>
                    <li>Try refreshing both tabs and testing again</li>
                </ul>
            </div>
            
            <div class="step">
                <h3>Common Issues:</h3>
                <ul>
                    <li><strong>Messages only in one tab:</strong> Cross-tab sync not working</li>
                    <li><strong>Duplicate messages:</strong> Message deduplication failed</li>
                    <li><strong>No messages at all:</strong> Basic chat functionality broken</li>
                </ul>
            </div>
        </div>
        
        <div class="section">
            <h2>🎉 Success Criteria</h2>
            <div class="good">
                <h3>✅ Test PASSES if:</h3>
                <ul>
                    <li>Messages typed in Tab 1 appear in Tab 2 immediately</li>
                    <li>Messages typed in Tab 2 appear in Tab 1 immediately</li>
                    <li>No duplicate messages appear</li>
                    <li>Sender names are correctly differentiated by color</li>
                    <li>Both Enter key and Send button work</li>
                    <li>Console shows successful broadcast/receive messages</li>
                </ul>
            </div>
        </div>
    </div>
    
    <script>
        let tab1, tab2;
        
        function openFirstTab() {
            tab1 = window.open('index.html', '_blank', 'width=1200,height=800');
            console.log('🚀 Opened Tab 1 for chat testing');
            
            // Add identifier to help distinguish tabs
            setTimeout(() => {
                if (tab1) {
                    tab1.postMessage({ type: 'SET_TAB_ID', id: 'TAB_1' }, '*');
                }
            }, 2000);
        }
        
        function openSecondTab() {
            tab2 = window.open('index.html', '_blank', 'width=1200,height=800,left=100,top=100');
            console.log('🚀 Opened Tab 2 for chat testing');
            
            // Add identifier to help distinguish tabs
            setTimeout(() => {
                if (tab2) {
                    tab2.postMessage({ type: 'SET_TAB_ID', id: 'TAB_2' }, '*');
                }
            }, 2000);
        }
        
        // Listen for messages from tabs
        window.addEventListener('message', (event) => {
            if (event.data.type === 'CHAT_STATUS') {
                console.log('📱 Tab Status:', event.data);
            }
        });
        
        console.log('💬 Chat sync test guide loaded');
        console.log('🎯 Ready to test cross-tab message synchronization!');
        
        // Add some helpful instructions
        setTimeout(() => {
            console.log('📝 Instructions:');
            console.log('1. Click "Open Tab 1" button');
            console.log('2. Click "Open Tab 2" button'); 
            console.log('3. Navigate to Battle Mode in both tabs');
            console.log('4. Send messages in each tab and verify they appear in the other tab');
        }, 1000);
    </script>
</body>
</html>