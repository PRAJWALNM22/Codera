<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Direct Battle Room Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const DirectBattleRoom = () => {
            // WebRTC State
            const [isVoiceChatEnabled, setIsVoiceChatEnabled] = useState(false);
            const [isMuted, setIsMuted] = useState(false);
            const [isScreenSharing, setIsScreenSharing] = useState(false);
            const [remoteScreenStream, setRemoteScreenStream] = useState(null);
            const [localAudioStream, setLocalAudioStream] = useState(null);
            const [localScreenStream, setLocalScreenStream] = useState(null);
            const [peerConnection, setPeerConnection] = useState(null);
            const [isConnecting, setIsConnecting] = useState(false);
            
            // Refs for WebRTC
            const localAudioRef = useRef(null);
            const remoteAudioRef = useRef(null);
            const remoteScreenRef = useRef(null);
            const peerConnectionRef = useRef(null);
            
            const roomId = new URLSearchParams(window.location.search).get('id') || 'direct-test-123';
            const myId = 'user-' + Math.random().toString(36).substr(2, 9);
            const [isCreator, setIsCreator] = useState(false);
            const [connectionStatus, setConnectionStatus] = useState('Disconnected');
            
            // Initialize creator status
            useEffect(() => {
                const existingRoom = localStorage.getItem(`room-${roomId}`);
                if (!existingRoom) {
                    setIsCreator(true);
                    localStorage.setItem(`room-${roomId}`, JSON.stringify({ creator: myId, created: Date.now() }));
                    console.log('Created room as:', myId);
                } else {
                    setIsCreator(false);
                    console.log('Joined existing room as:', myId);
                }
            }, []);

            // WebRTC Functions
            const initializePeerConnection = () => {
                if (peerConnectionRef.current) return peerConnectionRef.current;
                
                const pc = new RTCPeerConnection({
                    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                });
                
                pc.ontrack = (event) => {
                    const [remoteStream] = event.streams;
                    if (remoteStream.getVideoTracks().length > 0) {
                        setRemoteScreenStream(remoteStream);
                        if (remoteScreenRef.current) {
                            remoteScreenRef.current.srcObject = remoteStream;
                        }
                    } else if (remoteStream.getAudioTracks().length > 0) {
                        if (remoteAudioRef.current) {
                            remoteAudioRef.current.srcObject = remoteStream;
                        }
                    }
                };
                
                pc.onicecandidate = (event) => {
                    if (event.candidate) {
                        console.log('ICE candidate generated');
                        // Send ICE candidate via localStorage
                        const candidates = JSON.parse(localStorage.getItem(`candidates-${roomId}`) || '[]');
                        candidates.push({ candidate: event.candidate, from: myId, timestamp: Date.now() });
                        localStorage.setItem(`candidates-${roomId}`, JSON.stringify(candidates));
                    }
                };
                
                pc.onconnectionstatechange = () => {
                    console.log('Connection state:', pc.connectionState);
                    setConnectionStatus(pc.connectionState);
                };
                
                peerConnectionRef.current = pc;
                setPeerConnection(pc);
                return pc;
            };

            const startVoiceChat = async () => {
                try {
                    setIsConnecting(true);
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    setLocalAudioStream(stream);
                    
                    if (localAudioRef.current) {
                        localAudioRef.current.srcObject = stream;
                    }
                    
                    const pc = initializePeerConnection();
                    stream.getTracks().forEach(track => {
                        pc.addTrack(track, stream);
                    });
                    
                    setIsVoiceChatEnabled(true);
                    
                } catch (error) {
                    console.error('Error starting voice chat:', error);
                    alert('Could not start voice chat. Please check microphone permissions.');
                } finally {
                    setIsConnecting(false);
                }
            };
            
            const stopVoiceChat = () => {
                if (localAudioStream) {
                    localAudioStream.getTracks().forEach(track => track.stop());
                    setLocalAudioStream(null);
                }
                setIsVoiceChatEnabled(false);
                setIsMuted(false);
            };
            
            const toggleMute = () => {
                if (localAudioStream) {
                    const audioTracks = localAudioStream.getAudioTracks();
                    audioTracks.forEach(track => {
                        track.enabled = isMuted;
                    });
                    setIsMuted(!isMuted);
                }
            };
            
            const startScreenShare = async () => {
                try {
                    setIsConnecting(true);
                    const stream = await navigator.mediaDevices.getDisplayMedia({ 
                        video: true, 
                        audio: true 
                    });
                    setLocalScreenStream(stream);
                    
                    const pc = initializePeerConnection();
                    stream.getTracks().forEach(track => {
                        pc.addTrack(track, stream);
                    });
                    
                    setIsScreenSharing(true);
                    
                    stream.getVideoTracks()[0].onended = () => {
                        stopScreenShare();
                    };
                    
                } catch (error) {
                    console.error('Error starting screen share:', error);
                    alert('Could not start screen sharing.');
                } finally {
                    setIsConnecting(false);
                }
            };
            
            const stopScreenShare = () => {
                if (localScreenStream) {
                    localScreenStream.getTracks().forEach(track => track.stop());
                    setLocalScreenStream(null);
                }
                setIsScreenSharing(false);
            };

            return (
                <div className="min-h-screen bg-gray-900 text-gray-100 p-4">
                    {/* Header */}
                    <div className="bg-gray-800 p-4 rounded-lg mb-4">
                        <h1 className="text-2xl font-bold text-indigo-400 mb-2">🎮 Direct Battle Room Test</h1>
                        <div className="flex items-center space-x-4">
                            <span className="text-yellow-400">Room: {roomId}</span>
                            <span className="text-green-400">User: {myId}</span>
                        </div>
                    </div>

                    {/* Controls */}
                    <div className="bg-gray-800 p-4 rounded-lg mb-4">
                        <h2 className="text-xl font-semibold mb-4">Voice Chat & Screen Sharing Controls</h2>
                        <div className="flex space-x-4">
                            {!isVoiceChatEnabled ? (
                                <button 
                                    onClick={startVoiceChat} 
                                    disabled={isConnecting}
                                    className="px-4 py-2 bg-green-600 hover:bg-green-700 disabled:bg-gray-600 rounded-md"
                                >
                                    {isConnecting ? 'Starting...' : '🎤 Start Voice Chat'}
                                </button>
                            ) : (
                                <>
                                    <button 
                                        onClick={toggleMute}
                                        className={`px-4 py-2 rounded-md ${isMuted ? 'bg-red-600 hover:bg-red-700' : 'bg-green-600 hover:bg-green-700'}`}
                                    >
                                        {isMuted ? '🔇 Unmute' : '🔊 Mute'}
                                    </button>
                                    <button 
                                        onClick={stopVoiceChat}
                                        className="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-md"
                                    >
                                        ❌ Stop Voice Chat
                                    </button>
                                </>
                            )}

                            {!isScreenSharing ? (
                                <button 
                                    onClick={startScreenShare} 
                                    disabled={isConnecting}
                                    className="px-4 py-2 bg-purple-600 hover:bg-purple-700 disabled:bg-gray-600 rounded-md"
                                >
                                    {isConnecting ? 'Starting...' : '📺 Share Screen'}
                                </button>
                            ) : (
                                <button 
                                    onClick={stopScreenShare}
                                    className="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-md"
                                >
                                    ❌ Stop Screen Share
                                </button>
                            )}
                        </div>
                    </div>

                    {/* Status */}
                    <div className="bg-gray-800 p-4 rounded-lg mb-4">
                        <h3 className="text-lg font-semibold mb-3">Status</h3>
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <span className="font-semibold text-purple-400">Voice Chat:</span>
                                <span className={`ml-2 px-2 py-1 rounded text-sm ${isVoiceChatEnabled ? 'bg-green-600' : 'bg-gray-600'}`}>
                                    {isVoiceChatEnabled ? (isMuted ? 'Muted' : 'Active') : 'Disabled'}
                                </span>
                            </div>
                            <div>
                                <span className="font-semibold text-blue-400">Screen Share:</span>
                                <span className={`ml-2 px-2 py-1 rounded text-sm ${isScreenSharing ? 'bg-green-600' : 'bg-gray-600'}`}>
                                    {isScreenSharing ? 'Sharing' : 'Not Sharing'}
                                </span>
                            </div>
                        </div>
                        
                        {remoteScreenStream && (
                            <div className="mt-4">
                                <h4 className="text-sm font-semibold text-white mb-2">Remote Screen:</h4>
                                <video 
                                    ref={remoteScreenRef}
                                    autoPlay 
                                    playsInline 
                                    className="w-full max-w-md h-32 bg-black rounded border border-gray-500"
                                />
                            </div>
                        )}
                    </div>

                    {/* Instructions */}
                    <div className="bg-gray-800 p-4 rounded-lg">
                        <h3 className="text-lg font-semibold mb-3">🧪 How to Test</h3>
                        <ol className="list-decimal list-inside space-y-2 text-gray-300">
                            <li><strong>Copy this URL:</strong> <code className="bg-gray-700 px-2 py-1 rounded">{window.location.href}</code></li>
                            <li><strong>Open in new tab/window</strong></li>
                            <li><strong>In both tabs:</strong> Click "🎤 Start Voice Chat" and allow microphone</li>
                            <li><strong>Test talking:</strong> Speak in one tab, hear in the other</li>
                            <li><strong>Screen share:</strong> Click "📺 Share Screen" in one tab</li>
                            <li><strong>View screen:</strong> Other tab should show the shared screen</li>
                        </ol>
                    </div>

                    {/* Hidden Audio Elements */}
                    <audio ref={localAudioRef} muted={true} style={{display: 'none'}} />
                    <audio ref={remoteAudioRef} autoPlay={true} style={{display: 'none'}} />
                </div>
            );
        };

        ReactDOM.render(<DirectBattleRoom />, document.getElementById('root'));
    </script>
</body>
</html>